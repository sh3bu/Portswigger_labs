## Lab Description :

![image](https://github.com/user-attachments/assets/3dbb50b3-7759-45c2-af1d-505ab80e0c55)

## Solution :

Login to the site with the credentials provided - `wiener:peter`

**Normal GET request to /my-account** 
![image](https://github.com/user-attachments/assets/d11db6b8-4d26-467d-9092-643cc655aa61)

### Identifying the delimiter used by the Origin server -

Appending random characters at the end if the URI returns **404 NOT FOUND**,
![image](https://github.com/user-attachments/assets/f552fa26-ff48-45cb-98f5-8d8b7562f6f5)

Using the [delimiter list](https://portswigger.net/web-security/web-cache-deception/wcd-lab-delimiter-list) provided by Portswigger, we find that the Origin server uses `#`,`?`, `%23`, `%3F` characters as delimiter.

![image](https://github.com/user-attachments/assets/925b87d5-26e0-4ead-bc4a-20df80849119)

![image](https://github.com/user-attachments/assets/650f434d-dad1-448d-9998-300dde9d4919)

###  Analyzing normalization behaviour of origin server -

Appending a random directory prefix in the URI path returns **404 NOT FOUND**. This is because the origin server didn't normalize the path & since there is no such directory that starts with **/aaa/**, it returns **404 NOT FOUND**.

> This means that the **Origin server does not normalize the path/dot-segment** .

![image](https://github.com/user-attachments/assets/3793427c-666d-4b4f-8c47-322e33b1db6a)

### Analyzing cache rule of the cache server -

The cache server caches the response eventhough the **.js** extension is removed. 
> This means that the cache rule is not based on the file extension.

![image](https://github.com/user-attachments/assets/1fbd0cf7-a272-4400-ab83-f7f5594bd3e8)


### Analyzing normalization behaviour of cache server -

**Normal GET request to a static file**
![image](https://github.com/user-attachments/assets/bc8f6bff-08f0-4032-82fb-d0bd9379c0f7)

Eventhough we append a random directory like **/abcd/../** in between the URI, we get the expected contents of js file from the cache server. This is because the cache server normalizes the path & then returns the contents of the **labHeader.js** file from its cache.

> This means that the **cache server does normalize the path**.

![image](https://github.com/user-attachments/assets/1dec6abf-a170-4e99-b121-c5d459ed95d4)

### Crafting an exploit -

So based on our analysis, we know that

> Only the cache server performs normalization.
>
> The delimiter character used by the Origin server is `#`

So we can use the following payload in the exploit server to send the link to carlos on which he will click on it.

```js
<script>document.load="https://0a2b00fd0437ab9e80e11ccf00f800f5.web-security-academy.net/my-account%23%2f%2e%2e%2fresources/labheader/js/labHeader.js"</script>
```

**We URL encode the #/../ so that the victim's browser does not automatically decode the #/../ when carlos clicks on it.**

Once carlos clicks on the link, we can get the API key of carlos just by visiting the endpoint unauthenticated.

